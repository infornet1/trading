<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC Scalping Signal Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .time-selector {
            text-align: center;
            margin: 20px 0;
        }

        .time-selector button {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .time-selector button:hover {
            background: rgba(255,255,255,0.3);
        }

        .time-selector button.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-value.win {
            color: #4CAF50;
        }

        .stat-value.loss {
            color: #f44336;
        }

        .stat-value.neutral {
            color: #FFC107;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.7;
        }

        .signal-count {
            display: inline-block;
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: 10px;
        }

        .signals-table {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 1px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge.win {
            background: #4CAF50;
        }

        .badge.loss {
            background: #f44336;
        }

        .badge.pending {
            background: #FFC107;
            color: #000;
        }

        .badge.timeout {
            background: #9E9E9E;
        }

        .badge.long {
            background: #2196F3;
        }

        .badge.short {
            background: #FF5722;
        }

        .badge.conflict {
            background: #FF9800;
        }

        .signal-type {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
        }

        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .auto-refresh {
            text-align: center;
            margin: 20px 0;
            opacity: 0.7;
            font-size: 0.9em;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .updating {
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ“Š BTC Scalping Signal Tracker</h1>
            <p class="subtitle">Monitor signal performance and win rates in real-time</p>
        </header>

        <div class="time-selector">
            <button class="active" onclick="loadStats(1, this)">Last Hour</button>
            <button onclick="loadStats(6, this)">Last 6 Hours</button>
            <button onclick="loadStats(24, this)">Last 24 Hours</button>
            <button onclick="loadStats(168, this)">Last Week</button>
        </div>

        <div class="stats-grid" id="stats-grid">
            <div class="loading">Loading statistics...</div>
        </div>

        <div class="signals-table">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">
                    Recent Signals
                    <span class="signal-count" id="signal-count">0</span>
                </h2>
                <div class="time-selector" style="margin: 0;">
                    <button class="active" onclick="filterSignals('completed', this)">Win/Loss Only</button>
                    <button onclick="filterSignals('all', this)">Show All</button>
                    <button onclick="filterSignals('pending', this)">Pending Only</button>
                </div>
            </div>
            <table id="signals-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Direction</th>
                        <th>Price</th>
                        <th>RSI</th>
                        <th>Target</th>
                        <th>Stop</th>
                        <th>Outcome</th>
                        <th>P&L %</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="9" class="loading">Loading signals...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="auto-refresh">
            Auto-refreshing every 30 seconds...
        </div>

        <button class="refresh-btn" onclick="refreshAll()">ðŸ”„ Refresh Now</button>
    </div>

    <script>
        let currentHours = 1;
        let currentFilter = 'completed';  // Default filter: show only win/loss
        let allSignals = [];  // Store all signals for filtering

        function loadStats(hours, clickedButton) {
            currentHours = hours;

            // Update active button
            document.querySelectorAll('.time-selector button').forEach(btn => {
                btn.classList.remove('active');
            });
            if (clickedButton) {
                clickedButton.classList.add('active');
            }

            fetch(`/api/stats/${hours}`)
                .then(response => response.json())
                .then(data => {
                    displayStats(data);
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                });
        }

        function displayStats(stats) {
            const grid = document.getElementById('stats-grid');
            const winRate = stats.win_rate.toFixed(1);
            const winRateClass = winRate >= 60 ? 'win' : winRate >= 40 ? 'neutral' : 'loss';

            grid.innerHTML = `
                <div class="stat-card">
                    <h3>Total Signals</h3>
                    <div class="stat-value">${stats.total_signals}</div>
                    <div class="stat-label">${stats.completed} completed</div>
                </div>
                <div class="stat-card">
                    <h3>Win Rate</h3>
                    <div class="stat-value ${winRateClass}">${winRate}%</div>
                    <div class="stat-label">${stats.wins}W / ${stats.losses}L / ${stats.pending}P</div>
                </div>
                <div class="stat-card">
                    <h3>Avg Win</h3>
                    <div class="stat-value win">+${stats.avg_win_pct.toFixed(2)}%</div>
                    <div class="stat-label">Per winning trade</div>
                </div>
                <div class="stat-card">
                    <h3>Avg Loss</h3>
                    <div class="stat-value loss">-${stats.avg_loss_pct.toFixed(2)}%</div>
                    <div class="stat-label">Per losing trade</div>
                </div>
                <div class="stat-card">
                    <h3>Profit Factor</h3>
                    <div class="stat-value ${stats.profit_factor >= 1.5 ? 'win' : 'neutral'}">
                        ${stats.profit_factor.toFixed(2)}
                    </div>
                    <div class="stat-label">${stats.profit_factor >= 1.5 ? 'Excellent' : stats.profit_factor >= 1 ? 'Good' : 'Needs improvement'}</div>
                </div>
                <div class="stat-card">
                    <h3>Best Signal Type</h3>
                    <div class="stat-value" style="font-size: 1.2em;">${stats.best_signal_type}</div>
                    <div class="stat-label">Highest win rate</div>
                </div>
                <div class="stat-card">
                    <h3>Conflicting Signals</h3>
                    <div class="stat-value neutral">${stats.conflicts}</div>
                    <div class="stat-label">Avoided bad trades</div>
                </div>
                <div class="stat-card">
                    <h3>Timeouts</h3>
                    <div class="stat-value">${stats.timeouts}</div>
                    <div class="stat-label">No clear outcome</div>
                </div>
            `;
        }

        function loadSignals() {
            // Fetch many signals to include older completed ones
            // (Monitor generates ~30 signals/minute, so need large limit)
            fetch('/api/signals/recent/2000')
                .then(response => response.json())
                .then(data => {
                    allSignals = data;  // Store for filtering
                    displaySignals(filterSignalsByType(data, currentFilter));
                })
                .catch(error => {
                    console.error('Error loading signals:', error);
                });
        }

        function filterSignalsByType(signals, filterType) {
            if (filterType === 'completed') {
                // Show only WIN, LOSS, TIMEOUT (exclude PENDING and null)
                return signals.filter(sig =>
                    sig.final_result &&
                    ['WIN', 'LOSS', 'TIMEOUT'].includes(sig.final_result)
                );
            } else if (filterType === 'pending') {
                // Show only PENDING or null
                return signals.filter(sig =>
                    !sig.final_result || sig.final_result === 'PENDING'
                );
            } else {
                // Show all
                return signals;
            }
        }

        function filterSignals(filterType, clickedButton) {
            currentFilter = filterType;

            // Update active button in filter selector
            const filterButtons = clickedButton.parentElement.querySelectorAll('button');
            filterButtons.forEach(btn => btn.classList.remove('active'));
            clickedButton.classList.add('active');

            // Apply filter to current signals
            displaySignals(filterSignalsByType(allSignals, currentFilter));
        }

        function displaySignals(signals) {
            const tbody = document.querySelector('#signals-table tbody');
            const countBadge = document.getElementById('signal-count');

            // Update counter
            countBadge.textContent = signals.length;

            if (signals.length === 0) {
                let message = 'No signals yet. Start the monitor to collect data.';
                if (currentFilter === 'completed') {
                    message = 'No completed signals yet. Signals need time to reach target or stop loss.';
                } else if (currentFilter === 'pending') {
                    message = 'No pending signals. All signals have been resolved.';
                }
                tbody.innerHTML = `<tr><td colspan="9" class="loading">${message}</td></tr>`;
                return;
            }

            tbody.innerHTML = signals.map(sig => {
                const time = new Date(sig.timestamp).toLocaleString();
                const outcome = sig.final_result || 'PENDING';
                const outcomeClass = outcome.toLowerCase();
                const directionClass = sig.direction.toLowerCase();
                const pnl = sig.final_result === 'WIN' ? sig.max_gain_pct :
                           sig.final_result === 'LOSS' ? sig.max_loss_pct : 0;
                const pnlDisplay = pnl ? (pnl > 0 ? `+${pnl.toFixed(2)}%` : `${pnl.toFixed(2)}%`) : '-';
                const pnlClass = pnl > 0 ? 'win' : pnl < 0 ? 'loss' : '';

                return `
                    <tr>
                        <td>${time}</td>
                        <td><span class="signal-type">${sig.signal_type}</span></td>
                        <td><span class="badge ${directionClass}">${sig.direction}</span></td>
                        <td>$${sig.price.toFixed(2)}</td>
                        <td>${sig.rsi ? sig.rsi.toFixed(1) : '-'}</td>
                        <td>$${sig.suggested_target.toFixed(2)}</td>
                        <td>$${sig.suggested_stop.toFixed(2)}</td>
                        <td><span class="badge ${outcomeClass}">${outcome}</span></td>
                        <td><span class="${pnlClass}">${pnlDisplay}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function refreshAll() {
            const btn = document.querySelector('.refresh-btn');
            btn.classList.add('updating');
            btn.textContent = 'ðŸ”„ Updating...';

            loadStats(currentHours);
            loadSignals();

            setTimeout(() => {
                btn.classList.remove('updating');
                btn.textContent = 'ðŸ”„ Refresh Now';
            }, 1000);
        }

        // Initial load
        loadStats(1, null);  // null since no button clicked on initial load
        loadSignals();

        // Auto-refresh every 30 seconds
        setInterval(refreshAll, 30000);
    </script>
</body>
</html>
